<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent - è¯­éŸ³åˆæˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        .voice-card {
            padding: 16px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .voice-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .voice-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .voice-card.upload {
            border-style: dashed;
            border-color: #667eea;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .param-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .param-label {
            min-width: 80px;
            font-weight: 500;
            color: #666;
        }
        input[type="range"] {
            flex: 1;
        }
        select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .analysis-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .audio-player {
            width: 100%;
            margin: 16px 0;
        }
        .tip-box {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #1976d2;
            margin-top: 12px;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const API_BASE = 'http://localhost:8000';
        
        // æƒ…æ„Ÿæ ‡ç­¾åˆ—è¡¨
        const EMOTIONS = [
            { value: '', label: 'æ— ' },
            { value: '<|happy|>', label: '<|happy|> å¼€å¿ƒ' },
            { value: '<|angry|>', label: '<|angry|> ç”Ÿæ°”' },
            { value: '<|sad|>', label: '<|sad|> æ‚²ä¼¤' },
            { value: '<|excited|>', label: '<|excited|> å…´å¥‹' },
            { value: '<|surprised|>', label: '<|surprised|> æƒŠè®¶' },
            { value: '<|satisfied|>', label: '<|satisfied|> æ»¡æ„' },
            { value: '<|delighted|>', label: '<|delighted|> é«˜å…´' },
            { value: '<|scared|>', label: '<|scared|> å®³æ€•' },
            { value: '<|worried|>', label: '<|worried|> æ‹…å¿ƒ' },
            { value: '<|upset|>', label: '<|upset|> æ²®ä¸§' },
            { value: '<|nervous|>', label: '<|nervous|> ç´§å¼ ' },
            { value: '<|frustrated|>', label: '<|frustrated|> æ²®ä¸§' },
            { value: '<|depressed|>', label: '<|depressed|> æŠ‘éƒ' },
            { value: '<|empathetic|>', label: '<|empathetic|> å…±æƒ…' },
            { value: '<|embarrassed|>', label: '<|embarrassed|> å°´å°¬' },
            { value: '<|disgusted|>', label: '<|disgusted|> åŒæ¶' },
            { value: '<|moved|>', label: '<|moved|> æ„ŸåŠ¨' },
            { value: '<|proud|>', label: '<|proud|> éª„å‚²' },
            { value: '<|relaxed|>', label: '<|relaxed|> æ”¾æ¾' },
            { value: '<|grateful|>', label: '<|grateful|> æ„Ÿæ¿€' },
            { value: '<|confident|>', label: '<|confident|> è‡ªä¿¡' },
            { value: '<|interested|>', label: '<|interested|> æ„Ÿå…´è¶£' },
            { value: '<|curious|>', label: '<|curious|> å¥½å¥‡' },
            { value: '<|confused|>', label: '<|confused|> å›°æƒ‘' },
            { value: '<|joyful|>', label: '<|joyful|> å¿«ä¹' },
            { value: '<|disdainful|>', label: '<|disdainful|> è½»è”‘' },
            { value: '<|unhappy|>', label: '<|unhappy|> ä¸å¼€å¿ƒ' },
            { value: '<|anxious|>', label: '<|anxious|> ç„¦è™‘' },
            { value: '<|hysterical|>', label: '<|hysterical|> æ­‡æ–¯åº•é‡Œ' },
            { value: '<|indifferent|>', label: '<|indifferent|> å†·æ¼ ' },
            { value: '<|impatient|>', label: '<|impatient|> ä¸è€çƒ¦' },
            { value: '<|guilty|>', label: '<|guilty|> å†…ç–š' },
            { value: '<|scornful|>', label: '<|scornful|> è½»è”‘' },
            { value: '<|panicked|>', label: '<|panicked|> ææ…Œ' },
            { value: '<|furious|>', label: '<|furious|> æ„¤æ€’' },
            { value: '<|reluctant|>', label: '<|reluctant|> ä¸æƒ…æ„¿' },
            { value: '<|keen|>', label: '<|keen|> æ¸´æœ›' },
            { value: '<|disapproving|>', label: '<|disapproving|> ä¸èµæˆ' },
            { value: '<|negative|>', label: '<|negative|> æ¶ˆæ' },
            { value: '<|denying|>', label: '<|denying|> å¦è®¤' },
            { value: '<|astonished|>', label: '<|astonished|> éœ‡æƒŠ' },
            { value: '<|serious|>', label: '<|serious|> ä¸¥è‚ƒ' },
            { value: '<|sarcastic|>', label: '<|sarcastic|> è®½åˆº' },
            { value: '<|conciliative|>', label: '<|conciliative|> å®‰æŠš' },
            { value: '<|comforting|>', label: '<|comforting|> å®‰æ…°' },
            { value: '<|sincere|>', label: '<|sincere|> çœŸè¯š' },
            { value: '<|sneering|>', label: '<|sneering|> å˜²ç¬‘' },
            { value: '<|hesitating|>', label: '<|hesitating|> çŠ¹è±«' },
            { value: '<|yielding|>', label: '<|yielding|> å±ˆæœ' },
            { value: '<|painful|>', label: '<|painful|> ç—›è‹¦' },
            { value: '<|awkward|>', label: '<|awkward|> å°´å°¬' },
            { value: '<|amused|>', label: '<|amused|> é€—ä¹' },
        ];
        
        // é¢„è®¾éŸ³è‰²
        const PRESET_VOICES = [
            { id: 'xiaoxiao', name: 'æ™“æ™“', icon: 'ğŸ‘©' },
            { id: 'xiaoyi', name: 'å°è‰º', icon: 'ğŸ‘§' },
            { id: 'xiaoming', name: 'å°æ˜', icon: 'ğŸ‘¨' },
            { id: 'xiaogang', name: 'å°åˆš', icon: 'ğŸ‘¦' },
        ];

        function App() {
            // çŠ¶æ€
            const [phase, setPhase] = React.useState(1);
            const [text, setText] = React.useState('');
            const [voiceId, setVoiceId] = React.useState('');
            const [presetVoices, setPresetVoices] = React.useState([]);
            const [customAudio, setCustomAudio] = React.useState(null);
            const [sessionId, setSessionId] = React.useState(null);
            const [analysis, setAnalysis] = React.useState(null);
            const [params, setParams] = React.useState({ speed: 1.0, emotion_tag: '' });
            const [audioUrl, setAudioUrl] = React.useState(null);
            const [version, setVersion] = React.useState(0);
            const [loading, setLoading] = React.useState(false);
            
            // åé¦ˆç›¸å…³
            const [feedback, setFeedback] = React.useState('');
            const [feedbackPhase, setFeedbackPhase] = React.useState('input');
            const [feedbackResult, setFeedbackResult] = React.useState(null);
            const [adjustedParams, setAdjustedParams] = React.useState(null);

            // æ–‡ä»¶è¾“å…¥å¼•ç”¨
            const fileInputRef = React.useRef(null);

            // è·å–é¢„è®¾éŸ³è‰²åˆ—è¡¨
            React.useEffect(() => {
                fetch(`${API_BASE}/voices`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.voices && data.voices.length > 0) {
                            setPresetVoices(data.voices);
                            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                            if (!voiceId) {
                                setVoiceId(data.voices[0].id);
                            }
                        } else {
                            // ä½¿ç”¨é»˜è®¤éŸ³è‰²
                            setPresetVoices(PRESET_VOICES);
                            if (!voiceId) {
                                setVoiceId(PRESET_VOICES[0].id);
                            }
                        }
                    })
                    .catch(err => {
                        console.error('è·å–éŸ³è‰²åˆ—è¡¨å¤±è´¥:', err);
                        setPresetVoices(PRESET_VOICES);
                        if (!voiceId) {
                            setVoiceId(PRESET_VOICES[0].id);
                        }
                    });
            }, []);
            const startAnalysis = async () => {
                if (!text.trim()) {
                    alert('è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬');
                    return;
                }
                if (voiceId === 'custom' && !customAudio) {
                    alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶');
                    return;
                }

                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('text', text);
                    formData.append('voice_id', voiceId);
                    if (voiceId === 'custom' && customAudio) {
                        formData.append('reference_audio', customAudio);
                    }

                    const res = await fetch(`${API_BASE}/synthesize/analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'åˆ†æå¤±è´¥');
                    }
                    
                    const data = await res.json();
                    setSessionId(data.session_id);
                    setAnalysis(data.analysis);
                    setParams(data.suggested_params || { speed: 1.0, emotion_tag: '' });
                    setPhase(2);
                } catch (err) {
                    alert('åˆ†æå¤±è´¥: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // æ‰§è¡Œåˆæˆ
            const doSynthesize = async () => {
                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('session_id', sessionId);
                    formData.append('speed', params.speed);
                    formData.append('emotion_tag', params.emotion_tag);
                    if (voiceId === 'custom' && customAudio) {
                        formData.append('reference_audio', customAudio);
                    }

                    const res = await fetch(`${API_BASE}/synthesize`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'åˆæˆå¤±è´¥');
                    }
                    
                    const data = await res.json();
                    setAudioUrl(data.audio_url);
                    setVersion(data.version);
                    setPhase(3);
                    setFeedbackPhase('input');
                    setFeedback('');
                    setFeedbackResult(null);
                } catch (err) {
                    alert('åˆæˆå¤±è´¥: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // æäº¤åé¦ˆåˆ†æ
            const analyzeFeedback = async () => {
                if (!feedback.trim()) {
                    alert('è¯·è¾“å…¥åé¦ˆ');
                    return;
                }

                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('session_id', sessionId);
                    formData.append('feedback', feedback);

                    const res = await fetch(`${API_BASE}/synthesize/feedback/analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'åˆ†æå¤±è´¥');
                    }
                    
                    const data = await res.json();
                    setFeedbackResult(data);
                    setAdjustedParams(data.proposed_params);
                    setFeedbackPhase('analyzed');
                } catch (err) {
                    alert('åé¦ˆåˆ†æå¤±è´¥: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // åº”ç”¨åé¦ˆå¹¶åˆæˆ
            const applyFeedback = async () => {
                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('session_id', sessionId);
                    formData.append('apply_adjustments', 'true');
                    if (adjustedParams) {
                        formData.append('params', JSON.stringify(adjustedParams));
                    }

                    const res = await fetch(`${API_BASE}/synthesize/feedback/apply`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'åˆæˆå¤±è´¥');
                    }
                    
                    const data = await res.json();
                    setAudioUrl(data.audio_url);
                    setVersion(data.version);
                    setPhase(3);
                    setFeedbackPhase('input');
                    setFeedback('');
                    setFeedbackResult(null);
                } catch (err) {
                    alert('åˆæˆå¤±è´¥: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // é‡ç½®
            const reset = () => {
                setPhase(1);
                setText('');
                setVoiceId('xiaoxiao');
                setCustomAudio(null);
                setSessionId(null);
                setAnalysis(null);
                setParams({ speed: 1.0, emotion_tag: '' });
                setAudioUrl(null);
                setVersion(0);
                setFeedback('');
                setFeedbackPhase('input');
                setFeedbackResult(null);
                setAdjustedParams(null);
            };

            // å¤„ç†æ–‡ä»¶é€‰æ‹©
            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setCustomAudio(file);
                    setVoiceId('custom');
                }
            };

            // é˜¶æ®µ1: é€‰æ‹©éŸ³è‰²å’Œè¾“å…¥æ–‡æœ¬
            const renderPhase1 = () => (
                <>
                    <div className="section">
                        <div className="section-title">1. é€‰æ‹©éŸ³è‰²</div>
                        <div className="voice-grid">
                            {/* ä¸Šä¼ éŸ³é¢‘é€‰é¡¹ */}
                            <div 
                                className={`voice-card upload ${voiceId === 'custom' ? 'selected' : ''}`}
                                onClick={() => fileInputRef.current?.click()}
                            >
                                <div style={{fontSize: '32px', marginBottom: '8px'}}>ğŸ“¤</div>
                                <div>{customAudio ? customAudio.name : 'ä¸Šä¼ éŸ³é¢‘'}</div>
                                <div style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                    {customAudio ? `${(customAudio.size/1024).toFixed(1)}KB` : 'å…‹éš†éŸ³è‰²'}
                                </div>
                            </div>
                            <input 
                                ref={fileInputRef}
                                type="file" 
                                accept="audio/*"
                                className="hidden-input"
                                onChange={handleFileSelect}
                            />
                            
                            {/* é¢„è®¾éŸ³è‰² */}
                            {presetVoices.map(voice => (
                                <div 
                                    key={voice.id}
                                    className={`voice-card ${voiceId === voice.id ? 'selected' : ''}`}
                                    onClick={() => {
                                        setVoiceId(voice.id);
                                        setCustomAudio(null);
                                    }}
                                >
                                    <div style={{fontSize: '32px', marginBottom: '8px'}}>ğŸµ</div>
                                    <div>{voice.name}</div>
                                    {voice.description && (
                                        <div style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                            {voice.description}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="section">
                        <div className="section-title">2. è¾“å…¥æ–‡æœ¬</div>
                        <textarea 
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡å­—..."
                        />
                        <button className="btn btn-primary" onClick={startAnalysis} disabled={loading} style={{marginTop: '12px'}}>
                            {loading ? <span className="loading"></span> : 'ğŸ”'} æ™ºèƒ½åˆ†æ
                        </button>
                    </div>
                </>
            );

            // é˜¶æ®µ2: åˆ†æç»“æœå’Œå‚æ•°è°ƒæ•´
            const renderPhase2 = () => (
                <>
                    <div className="section">
                        <div className="section-title">ğŸ“Š åˆ†æç»“æœ</div>
                        <div className="analysis-box">
                            <div className="param-row">
                                <span className="param-label">åœºæ™¯</span>
                                <span>{analysis?.scene || '-'}</span>
                            </div>
                            <div className="param-row">
                                <span className="param-label">æƒ…æ„Ÿ</span>
                                <span>{analysis?.emotion || '-'}</span>
                            </div>
                            <div className="param-row">
                                <span className="param-label">ç†ç”±</span>
                                <span>{analysis?.reason || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <div className="section">
                        <div className="section-title">âš™ï¸ åˆæˆå‚æ•°</div>
                        
                        <div className="param-row">
                            <span className="param-label">è¯­é€Ÿ</span>
                            <input 
                                type="range" 
                                min="0.5" 
                                max="2.0" 
                                step="0.1"
                                value={params.speed}
                                onChange={(e) => setParams({...params, speed: parseFloat(e.target.value)})}
                            />
                            <span style={{minWidth: '50px'}}>{params.speed}x</span>
                        </div>
                        
                        <div className="param-row">
                            <span className="param-label">æƒ…æ„Ÿæ ‡ç­¾</span>
                            <select 
                                value={params.emotion_tag}
                                onChange={(e) => setParams({...params, emotion_tag: e.target.value})}
                            >
                                {EMOTIONS.map(e => (
                                    <option key={e.value} value={e.value}>{e.label}</option>
                                ))}
                            </select>
                        </div>

                        <button className="btn btn-primary" onClick={doSynthesize} disabled={loading} style={{marginTop: '12px'}}>
                            {loading ? <span className="loading"></span> : 'ğŸµ'} å¼€å§‹åˆæˆ
                        </button>
                    </div>
                </>
            );

            // é˜¶æ®µ3: æ’­æ”¾å’Œåé¦ˆ
            const renderPhase3 = () => (
                <>
                    <div className="section">
                        <div className="section-title">ğŸ§ åˆæˆç»“æœï¼ˆç¬¬{version}ç‰ˆï¼‰</div>
                        {audioUrl && (
                            <audio 
                                controls 
                                src={`${API_BASE}${audioUrl}`} 
                                className="audio-player"
                            />
                        )}
                    </div>

                    <div className="section">
                        <div className="section-title">ğŸ’¬ åé¦ˆä¼˜åŒ–</div>
                        
                        {feedbackPhase === 'input' && (
                            <>
                                <textarea 
                                    value={feedback}
                                    onChange={(e) => setFeedback(e.target.value)}
                                    placeholder="æè¿°ä½ çš„æ„Ÿå—ï¼Œå¦‚ï¼šè¯­é€Ÿå¤ªå¿«ã€æƒ…æ„Ÿä¸å¯¹..."
                                    style={{minHeight: '60px'}}
                                />
                                <div style={{marginTop: '12px'}}>
                                    <button className="btn btn-primary" onClick={analyzeFeedback} disabled={loading}>
                                        {loading ? <span className="loading"></span> : 'ğŸ¤–'} åˆ†æåé¦ˆ
                                    </button>
                                    <button className="btn btn-secondary" onClick={reset} style={{marginLeft: '10px'}}>
                                        ğŸ”„ é‡æ–°å¼€å§‹
                                    </button>
                                </div>
                            </>
                        )}

                        {feedbackPhase === 'analyzed' && feedbackResult && (
                            <>
                                <div className="analysis-box" style={{marginBottom: '15px'}}>
                                    <div style={{marginBottom: '10px'}}>
                                        <strong>ğŸ¤– å¤§æ¨¡å‹ç†è§£ï¼š</strong>
                                        <p style={{marginTop: '5px'}}>{feedbackResult.analysis}</p>
                                    </div>
                                    
                                    <div style={{marginBottom: '10px'}}>
                                        <strong>ğŸ“Š å‚æ•°è°ƒæ•´ï¼š</strong>
                                    </div>
                                    
                                    <div className="param-row">
                                        <span className="param-label">è¯­é€Ÿ</span>
                                        <input 
                                            type="range" 
                                            min="0.5" 
                                            max="2.0" 
                                            step="0.1"
                                            value={adjustedParams?.speed ?? params.speed}
                                            onChange={(e) => setAdjustedParams({...adjustedParams, speed: parseFloat(e.target.value)})}
                                        />
                                        <span>{adjustedParams?.speed ?? params.speed}x</span>
                                    </div>
                                    
                                    <div className="param-row">
                                        <span className="param-label">æƒ…æ„Ÿ</span>
                                        <select 
                                            value={adjustedParams?.emotion_tag ?? params.emotion_tag}
                                            onChange={(e) => setAdjustedParams({...adjustedParams, emotion_tag: e.target.value})}
                                        >
                                            {EMOTIONS.map(e => (
                                                <option key={e.value} value={e.value}>{e.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                <button className="btn btn-success" onClick={applyFeedback} disabled={loading}>
                                    {loading ? <span className="loading"></span> : 'âœ…'} ç¡®è®¤å¹¶é‡æ–°åˆæˆ
                                </button>
                                <button className="btn btn-secondary" onClick={() => setFeedbackPhase('input')} style={{marginLeft: '10px'}}>
                                    âŒ å–æ¶ˆ
                                </button>
                            </>
                        )}
                    </div>
                </>
            );

            return (
                <div className="container">
                    <h1>ğŸ™ï¸ Voice Agent</h1>
                    {phase === 1 && renderPhase1()}
                    {phase === 2 && renderPhase2()}
                    {phase === 3 && renderPhase3()}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
